# Exploiting SMB

<h2>Description</h2>
SMB - Server Message Block Protocol - is a client-server communication protocol used for sharing access to files, printers, serial ports and other resources on a network. In this Project, we're going to be exploiting anonymous SMB share access- a common misconfiguration that can allow us to gain information that will lead to a shell.</br>

<h2>Languages and Utilities Used</h2>

- <b>Nmap</b> 
- <b>Command Line</b>

<h2>Environments Used </h2>

- <b>Linux</b>

<h2>Program walk-through:</h2>

<p align="center">
<b>Enumerating SMB</b>
  
We need to gather information on a target in order to find potential attack vectors and aid in exploitation. We'll start by conducting a port scan.

<code>nmap 10.10.57.49 -vv</code>   

<img src="https://i.imgur.com/8EmJYWb.png" height="80%" width="80%" alt="Exploiting SMB" />

SMB is running on ports 139 and 445 as shown in the photo above. SMB originally ran on top of NetBIOS, which uses port 139. NetBIOS is an older transport layer which allows computers to talk to each other on the network. The SMB protocol runs on port 445, but may rely on NetBIOS to communicate with old devices that do not support the direct hosting of SMB over TCP/IP.

<b>Running full enumeration with enum4linux</b>


Enum4linux is a tool used to enumerate SMB shares on both Windows and Linux systems. We'll conduct a full basic enumeration.

<code>enum4linux 10.10.57.49 -a </code>

<img src="https://i.imgur.com/qZOcArd.png" height="80%" width="80%" alt="Exploiting SMB" />

The machine name of the SMB server is POLOSMB and it's running on OS version 6.1.

<img src="https://i.imgur.com/67w1MFl.png" height="80%" width="80%" alt="Exploiting SMB" />

The share ‘profiles’ look very interesting, and apparently provides info on different users.


<b>Exploiting SMB</b>


Now we need to access the SMB share, which can be done by ‘SMBClient’, available on Kali Linux. 

Lets see if our interesting share has been configured to allow anonymous access, I.E it doesn't require authentication to view the files. We can do this easily by:

- using the username "Anonymous"

- connecting to the share we found during the enumeration stage

- and not supplying a password.

<code>smbclient //10.10.57.49/profiles -U Anonymous</code>

<img src="https://i.imgur.com/EAwH4YF.png" height="80%" width="80%" alt="Exploiting SMB" />

‘Working From Home Information.txt’ sure sounds interesting! Let’s read it with the use of:

<code>more “Working From Home Information.txt”</code>

<img src="https://i.imgur.com/CjNOP4A.png" height="80%" width="80%" alt="Exploiting SMB" />

Apparentyly the profile folder belongs to a John Cactus and his account has been enabled with SSH to allow him to work from home. We can exploit this and access the main server remotely as well. We just need to have a pair of SSH keys (one public, and one private). 

Let’s move into the .ssh directory, by writing cd .ssh, followed by listing the contents of the directory (ls).

<img src="https://i.imgur.com/PSEEbjx.png" height="80%" width="80%" alt="Exploiting SMB" />

There are two files, id_rsa and id_rsa.pub. The latter file is the public key. We want to download the private key to our local machine first.

<img src="https://i.imgur.com/3E0EJdg.png" height="80%" width="80%" alt="Exploiting SMB" />

Next, change the permissions to “600” using “chmod 600 [file]”.

<img src="https://i.imgur.com/A5GwpK3.png" height="80%" width="80%" alt="Exploiting SMB" />

Here we can see that the permissions have been changed to allow the user to read and write the file.

<img src="https://i.imgur.com/jn7Jf9E.png" height="80%" width="80%" alt="Exploiting SMB" />

Now let's get the public key and exit the smb access.

<code> mget id_rsa.pub </code>

<img src="https://i.imgur.com/yz3XO44.png" height="80%" width="80%" alt="Exploiting SMB" />

Now we should see both files on our local machine.

<img src="https://i.imgur.com/lf1wwMf.png" height="80%" width="80%" alt="Exploiting SMB" />

Before being able to get access we need to move the private key to our .ssh directory by typing mv id_rsa /root/.ssh or dragging it using the GUI.

<img src="https://i.imgur.com/sjyl9X3.png" height="80%" width="80%" alt="Exploiting SMB" />


We need to find an username in order to remote access the server. This can be found by reading the public key file (more id_rsa.pub). 

<code>more id_rsa.pub</code>

The user name (cactus) is found at the end:

<img src="https://i.imgur.com/kdGvSqh.png" height="80%" width="80%" alt="Exploiting SMB" />

Now all the pieces are in place. Simply gain ssh access by writing:

<code>ssh cactus@10.10.57.49</code>


<img src="https://i.imgur.com/TcOt7k3.png" height="80%" width="80%" alt="Exploiting SMB" />

We're in! Let's open the text file:

<img src="https://i.imgur.com/D4U8HWa.png" height="80%" width="80%" alt="Exploiting SMB" />

We've successfully exploited SMB and remote accessed the server and found the flag!

</p>

  
    


